<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/mvc
		http://www.springframework.org/schema/mvc/spring-mvc-3.1.xsd">

	<mvc:interceptors>
		<bean class="mobi.nowtechnologies.server.interceptor.LoggerInterceptor" />
	</mvc:interceptors>
	
	<mvc:annotation-driven />
	
	
	<!-- Application properties     -->
	<bean id="propertyPlaceholderConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="locations">
			<list>
				<value>classpath:application.properties</value>
				<value>file:#{systemProperties['catalina.base']}/conf/application.properties</value>
			</list>
		</property>
		<property name="ignoreUnresolvablePlaceholders" value="true" />
		<property name="ignoreResourceNotFound" value="true" />
	</bean>

	<bean class="mobi.nowtechnologies.server.config.WebConfigPostProcessor"/>

	<bean id="transport.JaxbMarshallingView" class="org.springframework.web.servlet.view.xml.MarshallingView">
		<constructor-arg ref="transport.JaxbMarshaller" />
	</bean>

	<bean id="transport.JaxbMarshaller" class="org.springframework.oxm.jaxb.Jaxb2Marshaller">
		<property name="classesToBeBound">
			<list>
				<value>mobi.nowtechnologies.server.shared.dto.ChartDto</value>
				<value>mobi.nowtechnologies.server.persistence.domain.AccountLog</value>
				<value>mobi.nowtechnologies.server.shared.dto.AccountCheckDTO</value>
				<value>mobi.nowtechnologies.server.shared.dto.NewsDto</value>
				<value>mobi.nowtechnologies.server.shared.dto.NewsDetailDto</value>
				<value>mobi.nowtechnologies.server.shared.dto.BonusChartDetailDto</value>
				<value>mobi.nowtechnologies.server.shared.dto.ChartDetailDto</value>
				<value>mobi.nowtechnologies.server.persistence.domain.Response</value>
				<value>mobi.nowtechnologies.server.persistence.domain.DeviceSet</value>
				<value>mobi.nowtechnologies.server.shared.dto.DrmDto</value>
				<value>mobi.nowtechnologies.server.shared.dto.DrmItemDto</value>
				<value>mobi.nowtechnologies.server.persistence.domain.SetPassword</value>
				<value>mobi.nowtechnologies.server.shared.dto.BuyTrackDto</value>
				<value>mobi.nowtechnologies.server.persistence.domain.ErrorMessage</value>
				<value>mobi.nowtechnologies.server.persistence.domain.UserRegInfoServer</value>
				<value>mobi.nowtechnologies.server.persistence.domain.PaymentPolicy</value>
				<value>mobi.nowtechnologies.server.shared.dto.PromoCodeDto</value>
				<value>mobi.nowtechnologies.server.shared.dto.PaymentPolicyDto</value>
				<value>mobi.nowtechnologies.server.shared.dto.PurchasedChartDetailDto</value>
				<value>mobi.nowtechnologies.server.shared.dto.PurchasedChartDto</value>
				<value>mobi.nowtechnologies.server.dto.transport.PhoneActivationDto</value>
				<value>mobi.nowtechnologies.server.dto.transport.AccountCheckDto</value>
				<value>mobi.nowtechnologies.server.dto.transport.SelectedPlaylistDto</value>
				<value>mobi.nowtechnologies.server.dto.transport.LockedTrackDto</value>
				<value>mobi.nowtechnologies.server.shared.dto.PlaylistDto</value>
			</list>
		</property>
	</bean> 
		
	<bean class="org.springframework.web.servlet.view.ContentNegotiatingViewResolver">
	  <property name="order" value="1" />
      <property name="defaultContentType" value="application/xml" />
	  <property name="mediaTypes">
		<map>
		   <entry key="xml" value="application/xml"/>
		   <entry key="html" value="text/html"/>
		   <entry key="json" value="application/json" />
		</map>
	  </property>
 	<property name="viewResolvers">
		<list>
			<bean class="org.springframework.web.servlet.view.BeanNameViewResolver"/>
				<bean id="htmlViewResolver"
				class="org.springframework.web.servlet.view.InternalResourceViewResolver">
                <property name="order" value="2"/>
				<property name="prefix" value="/WEB-INF/views/" />
				<property name="suffix" value=".html" />
			</bean>
		</list>
	</property>
	  <property name="defaultViews">
		<list>
		  <bean class="org.springframework.web.servlet.view.json.MappingJacksonJsonView">
          </bean>
		  <ref bean="transport.JaxbMarshallingView"/>
		 </list>
	  </property>
	</bean>
	<!--
		 ****************************************************************************
		 ****************** Automatic job and thread-pool executors *****************
		 ****************************************************************************
	-->
	
		<!--	Sms According To Law job-->
	<bean id="transport.smsAccordingToLawQuartzJobDetail"
		class="org.springframework.scheduling.quartz.JobDetailBean">
		<property name="jobClass" value="mobi.nowtechnologies.server.job.SmsAccordingToLawJob" />
		<property name="jobDataAsMap">
			<map merge="true">
				<entry key="communityURL" value="runningtrax" />
				<entry key="userService" value-ref="service.UserService" />
				<entry key="messageSource" value-ref="serviceMessageSource" />
				<entry key="migHttpService" value-ref="service.migHttpService" />
				<entry key="communityService" value-ref="service.communityService" />
			</map>
		</property>
	</bean>
	
	<bean id="transport.smsAccordingToLawMoboQuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.smsAccordingToLawQuartzJobDetail" />
		<property name="startDelay"
			value="${smsAccordingToLawQuartzTrigger.startDelayMillis}" />
		<property name="repeatInterval"
			value="${smsAccordingToLawQuartzTrigger.repeatIntervalMillis}" />
		<property name="jobDataAsMap">
			<map merge="true">
				<entry key="communityURL" value="mobo" />
			</map>
		</property>
	</bean>

	<bean id="transport.smsAccordingToLawMetalHammerQuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.smsAccordingToLawQuartzJobDetail" />
		<property name="startDelay"
			value="${smsAccordingToLawQuartzTrigger.startDelayMillis}" />
		<property name="repeatInterval"
			value="${smsAccordingToLawQuartzTrigger.repeatIntervalMillis}" />
		<property name="jobDataAsMap">
			<map merge="true">
				<entry key="communityURL" value="MetalHammer" />
			</map>
		</property>
	</bean>
	
	<bean id="transport.smsAccordingToLawSamsungQuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.smsAccordingToLawQuartzJobDetail" />
		<property name="startDelay"
			value="${smsAccordingToLawQuartzTrigger.startDelayMillis}" />
		<property name="repeatInterval"
			value="${smsAccordingToLawQuartzTrigger.repeatIntervalMillis}" />
		<property name="jobDataAsMap">
			<map merge="true">
				<entry key="communityURL" value="samsung" />
			</map>
		</property>
	</bean>
	
	<bean id="transport.smsAccordingToLawRunningTraxQuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.smsAccordingToLawQuartzJobDetail" />
		<property name="startDelay"
			value="${smsAccordingToLawQuartzTrigger.startDelayMillis}" />
		<property name="repeatInterval"
			value="${smsAccordingToLawQuartzTrigger.repeatIntervalMillis}" />
		<property name="jobDataAsMap">
			<map merge="true">
				<entry key="communityURL" value="runningtrax" />
			</map>
		</property>
	</bean>
	
	<bean id="transport.smsAccordingToLawChartsNowQuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.smsAccordingToLawQuartzJobDetail" />
		<property name="startDelay"
			value="${smsAccordingToLawQuartzTrigger.startDelayMillis}" />
		<property name="repeatInterval"
			value="${smsAccordingToLawQuartzTrigger.repeatIntervalMillis}" />
		<property name="jobDataAsMap">
			<map merge="true">
				<entry key="communityURL" value="ChartsNow" />
			</map>
		</property>
	</bean>
	
	<bean id="transport.smsAccordingToLawO2QuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.smsAccordingToLawQuartzJobDetail" />
		<property name="startDelay"
			value="${smsAccordingToLawQuartzTrigger.startDelayMillis}" />
		<property name="repeatInterval"
			value="${smsAccordingToLawQuartzTrigger.repeatIntervalMillis}" />
		<property name="jobDataAsMap">
			<map merge="true">
				<entry key="communityURL" value="o2" />
			</map>
		</property>
	</bean>

	<bean id="transport.notificationJob" class="mobi.nowtechnologies.server.job.NotificationJob">
		<property name="numberOfThreads" value="${notificationJob.numberOfThreads}" />
		<property name="keystore" value="${notificationJob.keystore}" />
		<property name="password" value="${notificationJob.password}" />
		<property name="production" value="${notificationJob.production}" />
		<property name="communityName" value="Now Music" />
		<property name="badgeValue" value="${notificationJob.badgeValue}" />
		<property name="userIPhoneDetailsService" ref="service.UserIPhoneDetailsService" />
		<property name="chartDetailService" ref="service.ChartDetailService" />
		<property name="messageService" ref="service.MessageService" />
		<property name="userIPhoneDetailsListFetchSize" value="${notificationJob.userIPhoneDetailsListFetchSize}" />
	</bean>


	<bean id="transport.notificationQuartzJobDetail"
		class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
		<property name="targetObject" ref="transport.notificationJob" />
		<property name="targetMethod" value="execute" />
		<property name="concurrent" value="false" />
	</bean>
	<bean id="transport.notificationQuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.notificationQuartzJobDetail" />
		<property name="startDelay" value="${notificationQuartzTrigger.startDelayMillis}" />
		<property name="repeatInterval" value="${notificationQuartzTrigger.repeatIntervalMillis}" />
	</bean>
	
	<bean id="transport.notificationO2Job" class="mobi.nowtechnologies.server.job.NotificationJob">
		<property name="numberOfThreads" value="${notificationJob.numberOfThreads}" />
		<property name="keystore" value="${notificationJob.keystore}" />
		<property name="password" value="${notificationJob.password}" />
		<property name="production" value="${notificationJob.production}" />
		<property name="communityName" value="o2" />
		<property name="badgeValue" value="${notificationJob.badgeValue}" />
		<property name="userIPhoneDetailsService" ref="service.UserIPhoneDetailsService" />
		<property name="chartDetailService" ref="service.ChartDetailService" />
		<property name="messageService" ref="service.MessageService" />
		<property name="userIPhoneDetailsListFetchSize" value="${notificationJob.userIPhoneDetailsListFetchSize}" />
	</bean>

	<bean id="transport.notificationO2QuartzJobDetail"
		class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
		<property name="targetObject" ref="transport.notificationO2Job" />
		<property name="targetMethod" value="execute" />
		<property name="concurrent" value="false" />
	</bean>
	<bean id="transport.notificationO2QuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.notificationO2QuartzJobDetail" />
		<property name="startDelay" value="${notificationQuartzTrigger.startDelayMillis}" />
		<property name="repeatInterval" value="${notificationQuartzTrigger.repeatIntervalMillis}" />
	</bean>
	
	<!-- O2 sms notification job -->
	<bean id="transport.weeklyUpdateJob" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
		<property name="targetObject" ref="service.WeeklyUpdateService" />
		<property name="targetMethod" value="updateWeekly" />
		<property name="concurrent" value="false" />
	</bean>
	<bean id="transport.smsNotificationQuartzTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
		<property name="jobDetail" ref="transport.weeklyUpdateJob" />
		<property name="startDelay" value="${smsNotification.startDelayMillis}" />
		<property name="repeatInterval" value="${smsNotification.repeatIntervalMillis}" />
	</bean>
	
	
	<bean id="paymentExecutor" class="mobi.nowtechnologies.server.job.executor.PendingPaymentExecutor">
		<property name="executor">
			<bean class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor">
				<property name="corePoolSize" value="${executor.corePoolSize}" />
				<property name="maxPoolSize" value="${executor.maxPoolSize}" />
				<property name="queueCapacity" value="${executor.queueCapacity}" />
			</bean>
		</property>
		<property name="paymentSystems" ref="service.map.paymentSystems" />
	</bean>
	
	<!-- Payment task -->
	<bean id="paymentTask" class="mobi.nowtechnologies.server.job.CreatePendingPaymentJob">
		<property name="executor" ref="paymentExecutor" />
		<property name="pendingPaymentService" ref="service.PendingPaymentService" />
	</bean>
	<bean id="paymentJob" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
		<property name="targetObject" ref="paymentTask" />
		<property name="targetMethod" value="execute" />
		<property name="concurrent" value="false" />
	</bean>
	<bean id="paymentTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
    	<property name="jobDetail" ref="paymentJob" />
    	<property name="startDelay" value="${payment.job.startDelayMillis}" />
    	<property name="repeatInterval" value="${payment.job.repeatIntervalMillis}" />
	</bean>
	
	<!-- Retry Payment task -->
	<bean id="retryPaymentTask" class="mobi.nowtechnologies.server.job.CreateRetryPaymentJob">
		<property name="executor" ref="paymentExecutor" />
		<property name="pendingPaymentService" ref="service.PendingPaymentService" />
	</bean>
	<bean id="retryPaymentJob" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
		<property name="targetObject" ref="retryPaymentTask" />
		<property name="targetMethod" value="execute" />
		<property name="concurrent" value="false" /> 
	</bean>
	<bean id="retryPaymentTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
    	<property name="jobDetail" ref="retryPaymentJob" />
    	<property name="startDelay" value="${retry.job.startDelayMillis}" />
    	<property name="repeatInterval" value="${retry.job.repeatIntervalMillis}" />
	</bean>
	
	<!-- Expired Payment task -->
	<bean id="expiredPaymentTask" class="mobi.nowtechnologies.server.job.CleanExpirePendingPaymentsJob">
		<property name="pendingPaymentService" ref="service.PendingPaymentService" />
		<property name="paymentSystems" ref="service.map.paymentSystems" />
	</bean>
	<bean id="expiredPaymentJob" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
		<property name="targetObject" ref="expiredPaymentTask" />
		<property name="targetMethod" value="execute" />
		<property name="concurrent" value="false" />
	</bean>
	<bean id="expiredPaymentTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
    	<property name="jobDetail" ref="expiredPaymentJob" />
    	<property name="startDelay" value="${expired.job.startDelayMillis}" />
    	<property name="repeatInterval" value="${expired.job.repeatIntervalMillis}" />
	</bean>
	
	<!-- Before 48H O2 PSMS Payment task -->
	<bean id="before48hPSMSPaymentJob" class="org.springframework.scheduling.quartz.JobDetailBean">
		<property name="jobClass" value="mobi.nowtechnologies.server.job.Before48hPSMSPaymentJob" />
	</bean>
	
	<bean id="before48hPSMSPaymentTrigger" class="org.springframework.scheduling.quartz.CronTriggerBean">
		<property name="jobDetail" ref="before48hPSMSPaymentJob" />
		<property name="cronExpression" value="${before48h.expired.payment.job.cronExpression}" />
	</bean>

    <!-- Update O2 User Status Job -->
    <bean id="job.updateO2User" class="org.springframework.scheduling.quartz.JobDetailBean">
        <property name="jobClass" value="mobi.nowtechnologies.server.job.UpdateO2UserJob" />
    </bean>
    <bean id="job.UpdateO2UserTask" class="mobi.nowtechnologies.server.job.UpdateO2UserTask">
        <property name="userLogRepository" ref="userLogRepository"/>
        <property name="userService" ref="service.UserService"/>
        <property name="o2Service" ref="service.O2Service"/>
    </bean>
     
	<bean id="jobTrigger.updateO2User" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
    	<property name="jobDetail" ref="job.updateO2User" />
    	<property name="startDelay" value="${updateO2User.job.startDelayMillis}" />
    	<property name="repeatInterval" value="${updateO2User.job.repeatIntervalMillis}" />
	</bean>    
    
    <!-- Fork users job -->
    <bean id="job.ForkO2UsersForUpdateJob" class="org.springframework.scheduling.quartz.JobDetailBean">
        <property name="jobClass" value="mobi.nowtechnologies.server.job.ForkO2UsersForUpdateJob"/>
    </bean>
    
    <bean id="jobTrigger.ForkO2UsersForUpdateJob" class="org.springframework.scheduling.quartz.CronTriggerBean">
        <property name="jobDetail" ref="job.ForkO2UsersForUpdateJob"/>
        <property name="cronExpression" value="${jobs.default.cron.expression}"/>
    </bean>
     

    <bean id="schedulerTX" class="org.springframework.scheduling.quartz.SchedulerFactoryBean" lazy-init="false">
        <property name="applicationContextSchedulerContextKey" value="applicationContext" />
        <property name="dataSource" ref="persistence.DataSource"/>
        <property name="transactionManager" ref="persistence.TransactionManager"/>
        <property name="overwriteExistingJobs" value="true"/>
        <property name="autoStartup" value="${jobs.autoStartup}" />
        <property name="triggers">
            <list>
                <ref bean="jobTrigger.updateO2User"/>
                <ref bean="jobTrigger.ForkO2UsersForUpdateJob"/>
            </list>
        </property>
        <property name="quartzProperties">
            <props>
                <prop key="org.quartz.scheduler.instanceName">MQBatchScheduler</prop>
                <prop key="org.quartz.scheduler.instanceId">AUTO</prop>
                <prop key="org.quartz.jobStore.misfireThreshold">10000</prop>
                <prop key="org.quartz.jobStore.class">org.quartz.impl.jdbcjobstore.JobStoreTX</prop>
                <prop key="org.quartz.jobStore.driverDelegateClass">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</prop>
                <prop key="org.quartz.jobStore.isClustered">true</prop>
                <prop key="org.quartz.threadPool.class">org.quartz.simpl.SimpleThreadPool</prop>
                <prop key="org.quartz.threadPool.threadCount">5</prop>
                <prop key="org.quartz.threadPool.threadPriority">1</prop>
                <prop key="org.quartz.scheduler.skipUpdateCheck">true</prop>
            </props>
        </property>
    </bean>

    <bean class="mobi.nowtechnologies.server.job.SpringContext"/>

    <!-- NON_CLUSTERED JOBS-->
    <bean class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
		<property name="autoStartup" value="${jobs.autoStartup}" />
		<property name="triggers">
			<list>
				<ref bean="paymentTrigger"/>
				<ref bean="retryPaymentTrigger" />
				<ref bean="expiredPaymentTrigger" />
				<ref bean="transport.notificationQuartzTrigger" />
				<ref bean="transport.notificationO2QuartzTrigger" />
				<ref bean="transport.smsAccordingToLawSamsungQuartzTrigger" />
				<ref bean="transport.smsAccordingToLawChartsNowQuartzTrigger" />
				<ref bean="transport.smsAccordingToLawRunningTraxQuartzTrigger" />
				<ref bean="transport.smsAccordingToLawMoboQuartzTrigger" />
				<ref bean="transport.smsAccordingToLawO2QuartzTrigger" />
				<ref bean="transport.smsNotificationQuartzTrigger" />
				<ref bean="before48hPSMSPaymentTrigger"/>
			</list>
		</property>
	</bean>
	
	<!-- Transport only service -->
	<bean id="throttlingService" class="mobi.nowtechnologies.server.service.impl.ThrottlingServiceImpl">
		<property name="memcachedClient">
			<bean class="net.spy.memcached.MemcachedClient">
				<constructor-arg>
					<bean class="java.net.InetSocketAddress">
						<constructor-arg index="0" value="${throttling.host}" />
						<constructor-arg index="1" value="${throttling.port}" />
					</bean>
				</constructor-arg>
			</bean>
		</property>
	</bean> 
	<import resource="classpath:controllers.xml" />
</beans>
