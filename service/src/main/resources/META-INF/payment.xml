<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="
	http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
	http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="service.RefundService" class="mobi.nowtechnologies.server.service.impl.RefundServiceImpl">
        <property name="refundRepository" ref="refundRepository" />
    </bean>
	
	<bean id="service.PendingPaymentService" class="mobi.nowtechnologies.server.service.payment.impl.PendingPaymentServiceImpl">
		<property name="pendingPaymentRepository" ref="pendingPaymentRepository" />
		<property name="userRepository" ref="userRepository" />
		<property name="userService" ref="service.UserService" />
		<property name="paymentSystems" ref="service.map.paymentSystems" />
		<property name="paymentPolicyService" ref="service.PaymentPolicyService" />
        <property name="maxCount" value="${payment.service.max.users.count}"/>
	</bean>
	
	<bean id="service.SubmittedPaymentService" class="mobi.nowtechnologies.server.service.payment.impl.SubmittedPaymentServiceImpl">
		<property name="submittedPaymentRepository" ref="submittedPaymentRepository" />
	</bean>
	
	<bean id="service.AbstractPaymentSystemService" abstract="true">
		<property name="userService" ref="service.UserService" />
		<property name="paymentDetailsRepository" ref="paymentDetailsRepository" />
		<property name="submittedPaymentRepository" ref="submittedPaymentRepository" />
		<property name="pendingPaymentRepository" ref="pendingPaymentRepository" />
		<property name="paymentDetailsService" ref="service.PaymentDetailsService" />
        <property name="paymentEventNotifier" ref="commonPaymentEventNotifier"/>
	</bean>
	
	<!-- SagePay Service -->
    <bean id="sagePayHttpService" class="mobi.nowtechnologies.server.service.payment.http.SagePayHttpService">
        <property name="deferUrl" value="${sagepay.deferUrl}" />
        <property name="releaseUrl" value="${sagepay.releaseUrl}" />
        <property name="repeatUrl" value="${sagepay.repeatUrl}" />
        <property name="postService" ref="shared.PostService" />
        <property name="request">
            <bean class="mobi.nowtechnologies.server.service.payment.request.SagePayRequest" />
        </property>
    </bean>

	<bean id="service.sagePayPaymentService" class="mobi.nowtechnologies.server.service.payment.impl.SagePayPaymentServiceImpl" parent="service.AbstractPaymentSystemService">
		<property name="httpService" ref="sagePayHttpService"/>
		<property name="expireMillis" value="${sagepay.pendingExpireMillis}" />
	</bean>
	
	<!-- PayPal Service -->
    <bean class="mobi.nowtechnologies.server.service.payment.PayPalPaymentDetailsInfoService">
        <property name="retriesOnError" value="${paypal.retriesOnError}" />
    </bean>
    <bean class="mobi.nowtechnologies.server.service.payment.PayPalPaymentDetailsService">
        <property name="redirectURL" value="${paypal.redirectURL}" />
        <property name="httpService" ref="service.PayPalHttpService"/>
    </bean>

	<bean id="request.payPalRequest" class="mobi.nowtechnologies.server.service.payment.request.PayPalRequest">
		<property name="amountFormat" value="${paypal.amountFormat}" />
        <property name="communityResourceBundleMessageSource" ref="serviceMessageSource" />
	</bean>
	
	<bean id="service.payPalPaymentService" class="mobi.nowtechnologies.server.service.payment.impl.PayPalPaymentServiceImpl" parent="service.AbstractPaymentSystemService">
		<property name="expireMillis" value="${paypal.pendingExpireMillis}" />
		<property name="httpService" ref="service.PayPalHttpService"/>
	</bean>

    <bean id="service.PayPalHttpService" class="mobi.nowtechnologies.server.service.payment.http.PayPalHttpService">
        <property name="apiUrl" value="${paypal.apiUrl}" />
        <property name="postService" ref="shared.PostService" />
        <property name="request" ref="request.payPalRequest" />
    </bean>
	
	<!-- Mig Service -->
	<bean id="service.migHttpService" class="mobi.nowtechnologies.server.service.payment.http.MigHttpService">
		<property name="freeSMSURL" value="${mig.freeSMSURL}" />
		<property name="premiumSMSURL" value="${mig.premiumSMSURL}" />
		<property name="postService" ref="shared.PostService" />
		<property name="request">
			<bean class="mobi.nowtechnologies.server.service.payment.request.MigRequest" />
		</property>
		<property name="timeToLiveMin" value="${mig.timeToLiveMin}" />
	</bean>

    <bean id="pinMigService" class="mobi.nowtechnologies.server.service.payment.PinMigService" />
    <bean id="migPaymentDetailsService" class="mobi.nowtechnologies.server.service.payment.MigPaymentDetailsService">
    </bean>
    <bean class="mobi.nowtechnologies.server.service.payment.MigPaymentDetailsInfoService">
        <property name="retriesOnError" value="${mig.retriesOnError}" />
    </bean>
	<bean id="service.migPaymentService" class="mobi.nowtechnologies.server.service.payment.impl.MigPaymentServiceImpl" parent="service.AbstractPaymentSystemService">
		<property name="expireMillis" value="${mig.pendingExpireMillis}" />
		<property name="messageSource" ref="serviceMessageSource" />
		<property name="httpService" ref="service.migHttpService" />
	</bean>
    <bean class="mobi.nowtechnologies.server.service.payment.O2PSMSPaymentDetailsInfoService">
        <property name="retriesOnError" value="${o2.retriesOnError}" />
    </bean>
    <bean id="o2PSMSPaymentDetailsService" class="mobi.nowtechnologies.server.service.payment.O2PSMSPaymentDetailsService" />
	<bean id="service.o2PaymentService" class="mobi.nowtechnologies.server.service.payment.impl.O2PaymentServiceImpl" parent="service.AbstractPaymentSystemService">
		<property name="expireMillis" value="${o2.pendingExpireMillis}" />
		<property name="messageSource" ref="serviceMessageSource" />
		<property name="o2ClientService" ref="service.O2ClientService" />
	</bean>

	<bean id="iTunesPaymentSystemService" class="mobi.nowtechnologies.server.service.payment.impl.ITunesPaymentSystemService" parent="service.AbstractPaymentSystemService">
		<property name="expireMillis" value="${iTunes.pendingExpireMillis}" />
		<property name="iTunesClient" ref="service.ITunesClient"/>
		<property name="messageSource" ref="serviceMessageSource"/>
		<property name="helper" ref="iTunesPaymentSystemServiceHelper"/>
	</bean>

	<bean id="iTunesPaymentSystemServiceHelper" class="mobi.nowtechnologies.server.service.payment.ITunesPaymentSystemServiceHelper">
		<property name="iTunesPaymentDetailsService" ref="iTunesPaymentDetailsService"/>
		<property name="paymentDetailsRepository" ref="paymentDetailsRepository"/>
		<property name="pendingPaymentRepository" ref="pendingPaymentRepository"/>
		<property name="submittedPaymentService" ref="service.SubmittedPaymentService"/>
		<property name="timeService" ref="timeService"/>
		<property name="userService" ref="service.UserService"/>
		<property name="paymentPolicyService" ref="service.PaymentPolicyService"/>
		<property name="eventLoggerService" ref="eventLoggerService"/>
	</bean>

    <bean class="mobi.nowtechnologies.server.service.payment.SagePayPaymentDetailsInfoService">
        <property name="retriesOnError" value="${vf.retriesOnError}" />
    </bean>
    <bean id="sagePayPaymentDetailsService" class="mobi.nowtechnologies.server.service.payment.SagePayPaymentDetailsService"/>

    <bean class="mobi.nowtechnologies.server.service.payment.VFPSMSPaymentDetailsInfoService">
        <property name="retriesOnError" value="${vf.retriesOnError}" />
    </bean>
    <bean id="vfpsmsPaymentDetailsService" class="mobi.nowtechnologies.server.service.payment.VFPSMSPaymentDetailsService"/>
    <bean id="service.vfPaymentService" class="mobi.nowtechnologies.server.service.payment.impl.VFPaymentServiceImpl" parent="service.AbstractPaymentSystemService">
        <property name="expireMillis" value="${vf.pendingExpireMillis}" />
        <property name="messageSource" ref="serviceMessageSource" />
        <property name="gatewayService" ref="vf_nz.service.VFNZSMSGatewayService" />
        <property name="userService" ref="vf_nz.service.UserService" />
        <property name="pendingPaymentService" ref="service.PendingPaymentService" />
        <property name="userRepository" ref="userRepository" />
        <property name="paymentEventNotifier" ref="vfPaymentEventNotifier"/>
        <property name="paymentCodes">
            <set>
                <value>${vf.nz.smpp.service.source.address.billing.6gbp}</value>
                <value>${vf.nz.smpp.service.source.address.billing.1_5gbp}</value>
            </set>
        </property>
    </bean>

    <bean id="commonPaymentEventNotifier" class="mobi.nowtechnologies.server.service.payment.CommonPaymentEventNotifier">
        <property name="userNotificationService" ref="service.UserNotificationService" />
    </bean>

    <bean id="vfPaymentEventNotifier" class="mobi.nowtechnologies.server.service.payment.VFPaymentEventNotifier"/>


	<util:map id="service.map.paymentSystems" key-type="java.lang.String" value-type="mobi.nowtechnologies.server.service.payment.PaymentSystemService">
		<entry key="sagePayCreditCard" value-ref="service.sagePayPaymentService" />
		<entry key="payPal" value-ref="service.payPalPaymentService" />
		<entry key="migSms" value-ref="service.migPaymentService" />
		<entry key="o2Psms" value-ref="service.o2PaymentService" />	
		<entry key="vfPsms" value-ref="service.vfPaymentService" />
		<entry key="#{T(mobi.nowtechnologies.server.persistence.domain.payment.PaymentDetails).ITUNES_SUBSCRIPTION}" value-ref="iTunesPaymentSystemService" />
	</util:map>
	
	<!-- Listeners -->
	
	<bean id="subBalancePaymentListener" class="mobi.nowtechnologies.server.service.listener.SubBalancePaymentListener">
		<property name="userService" ref="service.UserService" />
		<property name="promotionService" ref="service.PromotionService" />
		<property name="userNotificationService" ref="service.UserNotificationService" />
	</bean>
	
	<!-- O2 SOA -->
	
	 <bean id="service.messageFactory" class="org.springframework.ws.soap.saaj.SaajSoapMessageFactory"/>
	 
	 <bean id="service.webServiceTemplate" class="org.springframework.ws.client.core.WebServiceTemplate">
        <constructor-arg ref="service.messageFactory"/>
        <property name="defaultUri" value="http://example.com/WebService"/>
    </bean>

    <import resource="payment-application-tests.xml" />
	 
</beans>